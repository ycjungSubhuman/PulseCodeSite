{% extends "base_sidebar.html" %}

{% block scrollbar %}
	<div class="navbar navbar-inverse" id='typetab' role="navigation">
		<ul class="nav">
			<li id="new" style="font-weight:bold;"><a href="#">New</a></li>
			<li id="liked"><a href="#">Liked</a></li>
			<li id="scraped"><a href="#">Scraped</a></li>
		</ul>
	</div>
	<div id="main">
		<ul id="linefeed">
		</ul>
	</div>

{% endblock scrollbar %}

{% block content %}
<span hidden>{{ csrf_token }}</span>
{{ block.super }}
	<input id="start_from" value="0" hidden/>
	<input id="type" value="new" hidden/>
{% endblock content %}


{% block style %}
{{ block.super }}
	{% load static %}
	<link href="{% static 'home.css' %}" rel="stylesheet">

{% endblock style %}


{% block script %}
{{ block.super }}
<script>
	var do_getResult = false;//stops from multiple POST call
	function getResult(){

		//get where to start
		var startfrom = $('#start_from').val();
		var type = $('#type').val();
		//ajax call
		$.ajax({
			type: "POST",
			url: '{% url "home:home" %}',
			data: {
				'isscroll': true,
				'startfrom': startfrom,
				'type': type,
			},
			success: function(data){
				/*---create DOMs and append them---*/
				for(var i in data.entity){
					dom_entity = $('<li></li>', {
						class: 'entity',
						id: 'entity'+startfrom+i,
					});

					//layouting
					var dom_background = $('<div></div>', {
						class: 'entitysection-background',
						id: dom_entity.attr('id')+'-background',
					}).css('background-image', 'url('+data.entity[i].bgimage_url+')');
					var dom_backcontainer = $('<div></div>',{
						class: 'entitysection-backcontainer'
					});
					var dom_header = $('<div></div>', {
						class: 'entitysection-header',
						id: dom_entity.attr('id')+'-header',
					});
					var dom_footer = $('<div></div>', {
						class: 'entitysection-footer',
						id: dom_entity.attr('id')+'-footer',
					});
					dom_background.append(dom_backcontainer);
					dom_backcontainer.append(dom_header).append(dom_footer);
					dom_entity.append(dom_background).appendTo('#linefeed');

					//---header: add author, title, and tag
					var header_author = $('<a></a>', {
						href: '/user/'+data.entity[i].author,
					}).html('<p class="header header-author"><span>'+data.entity[i].author+'</span></p>');
					var header_title = $('<a></a>', {
						href: '/'+data.entity[i].objtype+'/'+data.entity[i].author+'/'+data.entity[i].title,
					}).html('<p class="header header-title"><span>'+data.entity[i].title+'</span></p>');

					dom_header.append(header_author).append(header_title);
					//tags
					for(var tag_index in data.entity[i].tag){
						var tagspan = $('<a></a>', {
							href: '/search/tag/'+data.entity[i].tag[tag_index],
						}).html('<span class="footertag">'+data.entity[i].tag[tag_index]+'</span>');
						dom_header.append(tagspan);
					}

					//---footer: show tags and like/scrap buttons
					//comment/like/scrap
					var comment_button = $('<button></button>', {
						class: 'btn btn-default entitybutton entitybutton-comment',
						id: dom_entity.attr('id')+'-comment',
						title: 'View comments',
					}).html('<span class="glyphicon glyphicon-comment"></span>'+'<span>'+data.entity[i].comment_num+'</span>');
					var like_button = $('<button></button>', {
						class: 'btn btn-default entitybutton entitybutton-rightopen entitybutton-like',
						id: dom_entity.attr('id')+'-like',
						title: 'Like',
					}).html('<span class="glyphicon glyphicon-heart"></span>'+'<span>'+data.entity[i].liked_num+'</span>');
					var scrap_button = $('<button></button>', {
						class: 'btn btn-default entitybutton entitybutton-leftopen entitybutton-scrap',
						id: dom_entity.attr('id')+'-like',
						title: 'Scrap',
					}).html('<span class="glyphicon glyphicon-star"></span>');

					$('.entitybutton').attr("data-toggle", "tooltip");
					$('[data-toggle="tooltip"]').tooltip();
					dom_footer.append(scrap_button).append(like_button).append(comment_button);

					//add propercss class
					if(data.entity[i].objtype == 'journal'){
						dom_entity.addClass('entity-journal');
					}
					else{
						dom_entity.addClass('entity-track');

						//add player
						//player division 
						var player = $('<div></div>', {
							class: 'entity-player',
							id: dom_entity.attr('id')+'-player',
						});
						var player_small = $('<div></div>', {
							class: 'entity-player entity-player-small',
						}).hide();
						var button_section = $('<div></div>', {
							class: 'player-buttondiv'
						});
						var scrubber_section = $('<div></div>', {
							class: 'player-timebardiv',
						});
						var timedigit_section = $('<div></div>', {
							class: 'player-timedigitdiv'
						});
						//assembly div
						player.append(player_small);
						player_small.append(button_section).append(scrubber_section).append(timedigit_section);
						dom_header.after(player);

						//player components
						var audio = $('<audio></audio>', {
							class: 'audio',
							src: data.entity[i].track.audio_url,
							preload: 'none',
						});
						var overlapped_button = $('<button></button>', {
							class: 'btn btn-default audiobutton audiobutton-overlapped',
							title: 'Play the track',
						}).html('<span class="glyphicon glyphicon-play"></span><span>Play</span>');
						var play_button = $('<button></button>', {
							class: 'btn, btn-default audiobutton audiobutton-small',
							role: 'play',
							title: 'Play',
						}).html('<span class="glyphicon glyphicon-play"></span>').hide();
						var pause_button = $('<button></button>', {
							class: 'btn, btn-default audiobutton audiobutton-small',
							role: 'pause',
							title: 'pause',
						}).html('<span class="glyphicon glyphicon-pause"></span>');
						var scrubber_wrapper = $('<div></div>', {
							class: 'wrapper-scrubber',
						});
						var scrubber = $('<span></span>', {
							class: 'scrubber scrubber-background',
							id: dom_entity.attr('id')+'-scrubber',
						});
						var scrubber_loaded = $('<span></span>', {
							class: 'scrubber scrubber-loaded',
							id: dom_entity.attr('id')+'-scrubber-loaded',
						});
						var scrubber_played = $('<span></span>', {
							class: 'scrubber scrubber-played',
							id: dom_entity.attr('id')+'-scrubber-played',
						});
						var scrubber_nav = $('<span></span>', {
							class: 'scrubber scrubber-nav',
							id: dom_entity.attr('id')+'-scrubber-nav',
						});
						var playtime = $('<span></span>', {
							class: 'playtime',
							id: dom_entity.attr('id')+'-playtime',
						}).text('00:00');
						//assembly components
						player.append(audio).append(overlapped_button);
						button_section.append(play_button).append(pause_button);
						scrubber_wrapper.append(scrubber);
						scrubber_section.append(scrubber_wrapper);
						scrubber.append(scrubber_loaded).append(scrubber_played).append(scrubber_nav);
						timedigit_section.append(playtime);

						//define component actions
					}
				}
				/*---change startfrom---*/
				var entitynum = data.entitynum;
				$('#start_from').val(Number(startfrom)+entitynum);

				/*---adjust div height---*/
				var content_height = $('#linefeed').height();
				$('#content').css('height', content_height+60+52);//set contentdiv height
				$(window).trigger('page:appended');//set inner div height
				do_getResult = true;

				//action
			},
			failure: function(data){

			},
		});
	}
	$(document).ready(function(){
		$.ajaxSetup({
			headers: {'X-CSRFToken': getCookie("csrftoken")}
		});

		//on load, get 8 entities from the server
		getResult()

		
		$(window).scroll(function(e){//scroll loading event
			if(do_getResult){
				//if page has reached the bottom, load more docs
				if($(window).scrollTop()+$(window).height() >= ($(document).height())-30){
					do_getResult = false;
					getResult();
				}
			}
		});
		$(window).on('page:appended', function(e){
		 	//set div heigth according to #content
		 	var height_content = $('#content').css('height');
		 	$('#scrollbar').css('height', height_content);
		 	$('#sidebar').css({
		 		'height': height_content,
		 		'top': '-'+height_content,
		 	});
		});

		//audio player action define
		//big 'play' button
		$(document).on('click', '.audiobutton-overlapped', function(){
			var audio = $(this).parent().find('audio');
			$(this).hide();
			$(this).parent().find('.entity-player-small').show();
			$(this).parent().find('audio').load();
			$(this).parent().find('audio')[0].play();

			//event firing
			audio[0].loaded_updator = setInterval(function(){
				audio.trigger('updator:loading');
				return false;
			}, 500);
			audio[0].played_updator = setInterval(function(){
				audio.trigger('updator:playing');
				return false;
			}, 100);
		});
		//timebar & timedigit
		$(document).on('updator:loading', 'audio', function(e){
			var audio = e.target;
			var duration = audio.duration;
			var buffered;
			for(var i=0; i<audio.buffered.length; i++){
				buffered = buffered>audio.buffered.end(i) ? buffered:audio.buffered.end(i);
			}
			var width_full = parseInt($(audio).parent().find('.scrubber-background').css('width'), 10);
			var loaded_length = width_full * buffered/duration;
			$(audio).parent().find('.scrubber-loaded').css('width', loaded_length);

			if(buffered == duration){
				clearInterval(audio.loaded_updator);
			}
		});
		function keepTrackPlayed(e){
			var audio = e.target;
			var duration = audio.duration;
			var current = audio.currentTime;
			var width_full = parseInt($(audio).parent().find('.scrubber-background').css('width'), 10);
			var played_length = width_full * current/duration;
			var digit_current = pad(parseInt(current/60, 10), 2) + ':' + pad(parseInt(current)%60, 2);

			$(audio).parent().find('.scrubber-played').css('width', played_length);
			$(audio).parent().find('.playtime').text(digit_current);
		}
		$(document).on('updator:playing', 'audio', keepTrackPlayed);

		$(document).on('mousemove click', '.scrubber-nav', function(e){
			$(document).off('updator:playing');	

			var audio = $(e.target).parents('.entity-player').find('audio')[0]
			var offset = $(this).offset();
			var mousepos = e.pageX - offset.left;
			var width_full = parseInt($(audio).parent().find('.scrubber-background').css('width'), 10);
			var duration = audio.duration;
			var navtime = duration * mousepos/width_full;
			var navtext = pad(parseInt(navtime/60, 10), 2) + ':' + pad(parseInt(navtime)%60, 2);

			$(e.target).parents('.entity-player').find('.scrubber-played').css('width', mousepos).css('background-color', '#333355')
			$(e.target).parents('.entity-player').find('.playtime').text(navtext).css('color', '#7777dd');
			if(e.type == 'click'){
				audio.currentTime = navtime;
			}
		});
		$(document).on('touchstart', '.scrubber-nav', function(e){
			var audio = $(e.target).parents('.entity-player').find('audio')[0]
			var touch = e.originalEvent.touches[0];
			var offset = $(this).offset();
			var mousepos = touch.pageX - offset.left;
			var width_full = parseInt($(audio).parent().find('.scrubber-background').css('width'), 10);
			var duration = audio.duration;
			var navtime = duration * mousepos/width_full;

			audio.currentTime = navtime;
		});
		$(document).on('mouseout', '.scrubber-nav', function(e){
			$(e.target).parents('.entity-player').find('.scrubber-played').css('background-color', '#333333');
			$(e.target).parents('.entity-player').find('.playtime').css('color', '#ffffff');
			$(document).on('updator:playing', 'audio', keepTrackPlayed);
			$(e.target).parents('.entity-player').find('audio').trigger('updator:playing');

		});
	});	
</script>	
{% endblock script %}